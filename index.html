<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CBIT Connect</title>
<style>
/* ---------------- BASIC STYLES ---------------- */
* {margin:0; padding:0; box-sizing:border-box;}
body {font-family:Verdana, Arial, sans-serif; font-size:11px; background:#fff; color:#333;}
.header {background:#af2617; padding:8px 12px; border-bottom:1px solid #e12424;}
.header-content {max-width:950px; margin:0 auto; display:flex; justify-content:space-between; align-items:center;}
.logo {color:#fff; font-size:22px; font-weight:bold; text-decoration:none;}
.header-links {display:flex; gap:15px;}
.header-links a, .link-btn {color:#fff; text-decoration:none; font-size:11px; cursor:pointer;}
.header-links a:hover, .link-btn:hover {text-decoration:underline;}
.user-name {color:#fff; font-weight:bold; margin-right:10px;}
.login-page {background:#fff; padding:40px 20px;}
.login-container {max-width:450px; margin:60px auto; background:#fff; border:1px solid #ccc; padding:20px; border-radius:8px; box-shadow: 0 6px 18px rgba(0,0,0,0.04);}
.login-container h1 {color:#3B5998; font-size:18px; margin-bottom:8px; font-weight:bold;}
.login-container .subtitle {color:#666; font-size:11px; margin-bottom:20px; line-height:1.4;}
.form-row {margin-bottom:10px;}
.form-row label {display:block; color:#333; font-size:11px; font-weight:bold; margin-bottom:3px;}
.form-row input, .form-row select, .form-row textarea {width:100%; padding:8px 10px; border:1px solid #d0d7e6; font-size:13px; background:#fff; border-radius:6px;}
.form-row input:focus, .form-row select:focus, .form-row textarea:focus {outline:none; border-color:#3B5998; box-shadow:0 0 0 3px rgba(59,89,152,0.06);}
.form-row textarea {resize:vertical; min-height:80px;}
.btn {padding:8px 12px; background:#3B5998; color:#fff; border:1px solid #133783; font-size:13px; font-weight:bold; cursor:pointer; border-radius:6px;}
.btn:hover {background:#2E4A86;}
.btn:active {background:#133783;}
.btn-small {padding:6px 8px; font-size:12px; border-radius:6px;}
.link-btn {background:none; border:none; color:#3B5998; text-decoration:underline; font-size:11px; padding:0; cursor:pointer;}
.container {max-width:950px; margin:0 auto; padding:20px;}
.layout {display:table; width:100%; border-collapse:collapse;}
.sidebar {display:table-cell; width:220px; vertical-align:top; padding-right:10px;}
.main-content {display:table-cell; vertical-align:top; padding-left:10px; border-left:1px solid #eee;}
.sidebar-box {background:#f7f7f7; border:1px solid #eee; margin-bottom:10px; padding:12px; border-radius:8px;}
.sidebar-box h3 {color:#3B5998; font-size:12px; font-weight:bold; margin-bottom:8px; padding-bottom:5px; border-bottom:1px solid #ddd;}
.sidebar-menu {list-style:none;}
.sidebar-menu li {padding:6px 0; font-size:12px; cursor:pointer;}
.sidebar-menu li a {color:#3B5998; text-decoration:none;}
.sidebar-menu li a:hover {text-decoration:underline;}
.sidebar-menu li.active a {font-weight:bold;}
.content-box {background:#fff; border:1px solid #eee; margin-bottom:10px; padding:12px; border-radius:8px; box-shadow: 0 6px 14px rgba(0,0,0,0.03);}
.content-box h2 {color:#3B5998; font-size:16px; font-weight:bold; margin-bottom:8px; padding-bottom:5px; border-bottom:1px solid #f0f0f0;}
.tab-bar {display:flex; gap:6px; margin-bottom:10px;}
.tab {padding:6px 12px; background:#f7f7f7; border:1px solid #eee; cursor:pointer; font-size:12px; font-weight:600; color:#666; border-radius:8px;}
.tab:hover {background:#eee;}
.tab.active {background:#fff; color:#3B5998; border:1px solid #dfe8fb; box-shadow: 0 4px 10px rgba(59,89,152,0.04);}
.post-item {background:#fff; border:1px solid #f0f0f0; margin-bottom:10px; padding:12px; border-radius:8px;}
.post-item h3 {color:#173a8a; font-size:14px; font-weight:700; margin-bottom:6px;}
.post-item .meta {color:#666; font-size:12px; margin-bottom:8px;}
.post-item .info {color:#333; font-size:13px; margin:6px 0; line-height:1.5; white-space:pre-wrap;}
.post-item .skills {margin:8px 0;}
.skill {display:inline-block; background:#eaf1ff; padding:4px 8px; margin-right:6px; font-size:12px; color:#173a8a; border-radius:6px;}
.post-item .contact {margin-top:10px; padding-top:10px; border-top:1px solid #f3f3f3; display:flex; gap:10px; align-items:center;}
.post-item .contact a {color:#3B5998; text-decoration:none; font-size:13px;}
.post-item .contact a:hover {text-decoration:underline;}
.status {display:inline-block; color:#fff; padding:4px 8px; font-size:10px; font-weight:700; text-transform:uppercase; margin-left:8px; border-radius:6px;}
.status-hackathon {background:#6d9e31;}
.status-startup {background:#ff6b35;}
.status-project {background:#4ecdc4;}
.status-event {background:#9b59b6;}
.message {padding:10px; margin-bottom:12px; border:1px solid; font-size:13px; border-radius:6px;}
.message-success {background:#e8f5e9; border-color:#4caf50; color:#2e7d32;}
.message-error {background:#ffebee; border-color:#f44336; color:#c62828;}
.message-info {background:#e3f2fd; border-color:#2196f3; color:#1565c0;}
.empty {text-align:center; padding:30px; color:#999; font-size:13px;}
.loading {text-align:center; padding:20px; color:#666;}
.hidden {display:none !important;}
.footer {text-align:center; padding:20px; color:#999; font-size:12px; border-top:1px solid #eee; margin-top:20px;}
.modal {display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;}
.modal.show {display:flex;}
.modal-content {background:#fff; border:2px solid #3B5998; padding:15px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto; border-radius:8px;}
.modal-header {color:#3B5998; font-size:14px; font-weight:bold; margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid #ddd;}
.modal-body {margin:10px 0; font-size:13px; line-height:1.4;}
.modal-footer {margin-top:10px; padding-top:10px; border-top:1px solid #ddd; text-align:right;}
.modal-footer .btn {margin-left:8px;}
.auth-switch {margin-top:12px; text-align:center; font-size:12px;}
@media (max-width:768px) {.layout{display:block;}.sidebar, .main-content{display:block;width:100%;padding:0;border:none;}.sidebar{margin-bottom:10px;}}
</style>
</head>
<body>

<div id="authSection">
    <!-- Login -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <h1>CBIT Connect</h1>
            <p class="subtitle">Connect with CBIT students for hackathons, startups, projects, and tech events.</p>
            <div id="loginMessage"></div>
            <div class="form-row"><label>Email:</label><input type="email" id="loginEmail" placeholder="yourname@cbit.ac.in"></div>
            <div class="form-row"><label>Password:</label><input type="password" id="loginPassword"></div>
            <div class="form-row"><button class="btn" type="button" id="loginBtn">Login</button></div>
            <div class="auth-switch">Don't have an account? <button class="link-btn" id="switchToSignupBtn">Sign Up</button></div>
        </div>
    </div>

    <!-- Signup -->
    <div id="signupPage" class="login-page hidden">
        <div class="login-container">
            <h1>Sign Up</h1>
            <p class="subtitle">Create your account to join CBIT Connect. (Only @cbit.ac.in allowed)</p>
            <div id="signupMessage"></div>
            <div class="form-row"><label>Name:</label><input type="text" id="signupName" placeholder="Your full name"></div>
            <div class="form-row"><label>Email:</label><input type="email" id="signupEmail" placeholder="yourname@cbit.ac.in"></div>
            <div class="form-row"><label>Password:</label><input type="password" id="signupPassword" placeholder="Min 6 characters"></div>
            <div class="form-row"><label>Year:</label>
                <select id="signupYear">
                    <option value="1">1st</option>
                    <option value="2">2nd</option>
                    <option value="3">3rd</option>
                    <option value="4">4th</option>
                </select>
            </div>
            <div class="form-row"><label>Branch:</label><input type="text" id="signupBranch" placeholder="CSE/IT/ECE/etc."></div>
            <div class="form-row"><label>WhatsApp Number (digits only):</label><input type="text" id="signupWhatsapp" placeholder="e.g. 919812345678"></div>
            <div class="form-row"><button class="btn" type="button" id="signupBtn">Sign Up</button></div>
            <div class="auth-switch">Already have an account? <button class="link-btn" id="switchToLoginBtn">Login</button></div>
        </div>
    </div>
</div>

<!-- Main App -->
<div id="app" class="hidden">
    <div class="header">
        <div class="header-content">
            <a href="#" class="logo">CBIT Connect</a>
            <div class="header-links">
                <span class="user-name" id="userNameDisplay"></span>
                <button class="btn-small" id="logoutBtn">Logout</button>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="layout">
            <div class="sidebar">
                <div class="sidebar-box">
                    <h3>Menu</h3>
                    <ul class="sidebar-menu">
                        <li class="active" id="tabDiscover"><a href="#">Discover</a></li>
                        <li id="tabMyPosts"><a href="#">My Posts</a></li>
                        <li id="tabCreate"><a href="#">Create Post</a></li>
                    </ul>
                </div>
            </div>
            <div class="main-content">
                <!-- Discover -->
                <div id="discoverTab" class="content-box">
                    <h2>Discover Posts</h2>
                    <div class="tab-bar" id="filterTabs">
                        <div class="tab active" data-type="all">All</div>
                        <div class="tab" data-type="hackathon">Hackathon</div>
                        <div class="tab" data-type="startup">Startup</div>
                        <div class="tab" data-type="project">Project</div>
                        <div class="tab" data-type="event">Event</div>
                    </div>
                    <div id="postsLoading" class="loading hidden">Loading posts...</div>
                    <div id="postsContainer" class="posts-container"></div>
                </div>

                <!-- My Posts -->
                <div id="myPostsTab" class="content-box hidden">
                    <h2>My Posts</h2>
                    <div id="myPostsLoading" class="loading hidden">Loading your posts...</div>
                    <div id="myPostsContainer"></div>
                </div>

                <!-- Create Post -->
                <div id="createTab" class="content-box hidden">
                    <h2>Create New Post</h2>
                    <div id="createMessage"></div>
                    <div class="form-row"><label>Title:</label><input type="text" id="postTitle" placeholder="e.g., Looking for React Developer"></div>
                    <div class="form-row"><label>Description:</label><textarea id="postDescription" placeholder="Describe your hackathon/startup/project..."></textarea></div>
                    <div class="form-row"><label>Type:</label>
                        <select id="postType">
                            <option value="hackathon">Hackathon</option>
                            <option value="startup">Startup</option>
                            <option value="project">Project</option>
                            <option value="event">Event</option>
                        </select>
                    </div>
                    <div class="form-row"><label>Skills (comma separated):</label><input type="text" id="postSkills" placeholder="React, Node.js, Python"></div>
                    <div class="form-row"><label>Expiry Hours (1-168):</label><input type="number" id="postExpiry" placeholder="24" value="24" min="1" max="168"></div>
                    <div class="form-row"><button class="btn" id="createPostBtn">Create Post</button></div>
                </div>
            </div>
        </div>
    </div>
    <div class="footer">CBIT Connect &copy; 2025</div>
</div>

<!-- Contact Modal -->
<div id="contactModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Contact Confirmation</div>
        <div class="modal-body">You are about to contact this user via WhatsApp. Proceed?</div>
        <div class="modal-footer">
            <button class="btn" id="cancelContactBtn">Cancel</button>
            <button class="btn" id="confirmWhatsAppBtn">Yes</button>
        </div>
    </div>
</div>

<script type="module">
// ---------------- SUPABASE SETUP ----------------
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = 'https://yrjdceazbyapzninojdd.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlyamRjZWF6YnlhcHpuaW5vamRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2ODE4NzksImV4cCI6MjA3NTI1Nzg3OX0.cv27XRItKhZVp9r3rvJTFv7ekA4KVhto7MGfJiO7JiQ';
const supabase = createClient(supabaseUrl, supabaseKey);

let currentUser = null;
let pendingWhatsAppUrl = null;
let postsData = [];
let currentFilter = 'all';

// ---------------- UTIL ----------------
function showMessage(elementId, message, type = 'success') {
    const el = document.getElementById(elementId);
    if (!el) return;
    el.innerHTML = `<div class="message message-${type}">${type === 'success' ? '✅ ' : type === 'error' ? '⚠️ ' : 'ℹ️ '} ${message}</div>`;
    setTimeout(() => { if (el) el.innerHTML = ''; }, 4500);
}

function escapeHTML(str = '') {
    return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}

function showElement(id){ document.getElementById(id)?.classList.remove('hidden'); }
function hideElement(id){ document.getElementById(id)?.classList.add('hidden'); }

// ---------------- AUTH ----------------
async function handleLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!email || !password) { 
        showMessage('loginMessage', 'Email and password required.', 'error'); 
        return; 
    }
    
    showMessage('loginMessage', 'Signing in...', 'info');

    try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        
        if (error) { 
            showMessage('loginMessage', error.message, 'error'); 
            return; 
        }
        
        if (!data.user) { 
            showMessage('loginMessage', 'Sign in failed. Please check your credentials.', 'error'); 
            return; 
        }

        currentUser = data.user;
        showApp();
    } catch (err) {
        showMessage('loginMessage', 'Login failed. Please try again.', 'error');
    }
}

async function handleSignup() {
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const name = document.getElementById('signupName').value.trim();
    const year = parseInt(document.getElementById('signupYear').value);
    const branch = document.getElementById('signupBranch').value.trim();
    const whatsapp = document.getElementById('signupWhatsapp').value.trim();

    if (!name || !email || !password || !branch || !whatsapp) {
        showMessage('signupMessage', 'Please fill in all fields.', 'error'); 
        return;
    }
    
    if (password.length < 6) { 
        showMessage('signupMessage', 'Password should be at least 6 characters.', 'error'); 
        return; 
    }

    if (!email.toLowerCase().endsWith('@cbit.ac.in')) {
        showMessage('signupMessage', 'Only @cbit.ac.in emails are allowed.', 'error'); 
        return;
    }

    if (!/^\d{10,15}$/.test(whatsapp)) {
        showMessage('signupMessage', 'Enter a valid WhatsApp number (digits only).', 'error'); 
        return;
    }

    showMessage('signupMessage', 'Creating account...', 'info');
    
    try {
        const { data, error } = await supabase.auth.signUp({ 
            email, 
            password,
            options: {
                data: {
                    name: name,
                    year: year,
                    branch: branch,
                    whatsapp: whatsapp
                }
            }
        });

        if (error) { 
            showMessage('signupMessage', error.message, 'error'); 
            return; 
        }

        if (!data.user) {
            showMessage('signupMessage', 'Account created. Please check your email to confirm signup.', 'success');
            setTimeout(() => switchToLogin(), 3000);
            return;
        }

        const insertResp = await supabase.from('profiles').insert({
            id: data.user.id,
            name,
            year,
            branch,
            whatsapp
        });

        if (insertResp.error) {
            showMessage('signupMessage', 'Account created. You can login now.', 'success');
        } else {
            showMessage('signupMessage', 'Signup successful! Redirecting...', 'success');
        }

        currentUser = data.user;
        setTimeout(() => showApp(), 1500);
    } catch (err) {
        showMessage('signupMessage', 'Signup failed. Please try again.', 'error');
    }
}

function switchToSignup() { 
    hideElement('loginPage'); 
    showElement('signupPage'); 
}

function switchToLogin() { 
    hideElement('signupPage'); 
    showElement('loginPage'); 
}

// ---------------- APP ----------------
function showApp() {
    hideElement('authSection');
    showElement('app');
    loadUserProfile();
    loadAllPosts();
    loadMyPosts();
}

async function loadUserProfile() {
    if (!currentUser) return;
    
    try {
        const { data: profile, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();

        if (!error && profile) {
            document.getElementById('userNameDisplay').innerText = profile.name;
        } else {
            document.getElementById('userNameDisplay').innerText = (currentUser?.email || 'User');
        }
    } catch (err) {
        document.getElementById('userNameDisplay').innerText = (currentUser?.email || 'User');
    }
}

// ---------------- POSTS ----------------
async function loadAllPosts() {
    showElement('postsLoading');
    
    try {
        const { data: posts, error } = await supabase
            .from('posts')
            .select('*, profiles(name, whatsapp)')
            .order('created_at', { ascending:false });

        hideElement('postsLoading');

        if (error) {
            document.getElementById('postsContainer').innerHTML = `
                <div class="message message-info">
                    <strong>No posts found.</strong> Be the first to create one!
                </div>
            `;
            return; 
        }
        
        postsData = posts || [];
        const now = new Date();
        const active = (postsData || []).filter(p => new Date(p.expires_at) > now);
        renderPosts(active, 'postsContainer');
    } catch (err) {
        hideElement('postsLoading');
        document.getElementById('postsContainer').innerHTML = '<div class="empty">Unable to load posts.</div>';
    }
}

async function loadMyPosts() {
    if (!currentUser) return;
    
    showElement('myPostsLoading');
    
    try {
        const { data: posts, error } = await supabase
            .from('posts')
            .select('*, profiles(name, whatsapp)')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending:false });
            
        hideElement('myPostsLoading');
        
        if (error) {
            document.getElementById('myPostsContainer').innerHTML = '<div class="empty">Unable to load your posts.</div>';
            return; 
        }
        
        renderPosts((posts||[]), 'myPostsContainer', true);
    } catch (err) {
        hideElement('myPostsLoading');
        document.getElementById('myPostsContainer').innerHTML = '<div class="empty">Unable to load your posts.</div>';
    }
}

function renderPosts(posts, containerId, allowDelete=false) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    const now = new Date();
    
    if (!posts || posts.length === 0) { 
        container.innerHTML = '<div class="empty">No posts available. Be the first to create one!</div>'; 
        return; 
    }

    posts.forEach(post => {
        const expiresAt = new Date(post.expires_at);
        if (expiresAt < now) return;

        const diff = expiresAt - now;
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);

        const skillsHtml = post.skills ? escapeHTML(post.skills).split(',').map(s => `<span class="skill">${escapeHTML(s.trim())}</span>`).join('') : '';
        const safeTitle = escapeHTML(post.title);
        const safeDesc = escapeHTML(post.description);
        const whatsappNumber = post.profiles?.whatsapp ? escapeHTML(post.profiles.whatsapp) : '';

        const deleteHtml = allowDelete && currentUser && post.user_id === currentUser.id 
            ? `<a href="#" class="delete-post-link" data-post-id="${post.id}">Delete</a>` 
            : '';

        const postDiv = document.createElement('div');
        postDiv.className = 'post-item';
        postDiv.dataset.expires = expiresAt.toISOString();
        postDiv.dataset.user = escapeHTML(post.profiles?.name || 'Unknown');
        postDiv.innerHTML = `
            <h3>${safeTitle} <span class="status status-${escapeHTML(post.type)}">${escapeHTML(post.type)}</span></h3>
            <div class="meta">Posted by ${escapeHTML(post.profiles?.name || 'Unknown')} • Expires in ${hours}h ${minutes}m ${seconds}s</div>
            <div class="info">${safeDesc}</div>
            <div class="skills">${skillsHtml}</div>
            <div class="contact">
                <a href="#" class="contact-link" data-whatsapp="${whatsappNumber}">Contact on WhatsApp</a>
                ${deleteHtml}
            </div>
        `;
        
        container.appendChild(postDiv);
    });

    container.querySelectorAll('.contact-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const whatsapp = e.target.dataset.whatsapp;
            startContact(whatsapp);
        });
    });

    container.querySelectorAll('.delete-post-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const postId = e.target.dataset.postId;
            deletePost(postId);
        });
    });
}

// ---------------- POST CREATE ----------------
async function createPost() {
    if (!currentUser) { 
        showMessage('createMessage', 'You must be logged in to create a post.', 'error'); 
        return; 
    }

    const title = document.getElementById('postTitle').value.trim();
    const description = document.getElementById('postDescription').value.trim();
    const type = document.getElementById('postType').value;
    const skills = document.getElementById('postSkills').value.trim();
    const expiryHours = parseInt(document.getElementById('postExpiry').value) || 24;

    if (!title || !description) { 
        showMessage('createMessage', 'Title and description are required.', 'error'); 
        return; 
    }
    
    if (isNaN(expiryHours) || expiryHours < 1 || expiryHours > 168) { 
        showMessage('createMessage', 'Expiry should be between 1 and 168 hours.', 'error'); 
        return; 
    }

    showMessage('createMessage', 'Creating post...', 'info');

    const expiresAt = new Date(Date.now() + expiryHours * 3600 * 1000);

    try {
        const { error } = await supabase.from('posts').insert({
            title, 
            description, 
            type, 
            skills, 
            user_id: currentUser.id, 
            expires_at: expiresAt.toISOString()
        });

        if (error) { 
            showMessage('createMessage', 'Failed to create post. Please try again.', 'error'); 
            return; 
        }
        
        showMessage('createMessage', 'Post created successfully!', 'success');

        document.getElementById('postTitle').value = '';
        document.getElementById('postDescription').value = '';
        document.getElementById('postSkills').value = '';
        document.getElementById('postExpiry').value = '24';

        await loadAllPosts();
        await loadMyPosts();
        
        setTimeout(() => showTab('discover'), 1000);
    } catch (err) {
        showMessage('createMessage', 'Failed to create post. Please try again.', 'error');
    }
}

// ---------------- POST DELETE ----------------
async function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post?')) return;
    
    try {
        const { error } = await supabase.from('posts').delete().eq('id', postId);
        
        if (error) { 
            alert('Delete failed. Please try again.'); 
            return; 
        }
        
        await loadAllPosts();
        await loadMyPosts();
    } catch (err) {
        alert('Delete failed. Please try again.');
    }
}

// ---------------- FILTER ----------------
function filterTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentFilter = tab.dataset.type;
    
    const filtered = currentFilter === 'all' 
        ? postsData 
        : (postsData || []).filter(p => p.type === currentFilter);
    
    const now = new Date();
    renderPosts((filtered || []).filter(p => new Date(p.expires_at) > now), 'postsContainer');
}

// ---------------- TAB SWITCH ----------------
function showTab(tabName) {
    hideElement('discoverTab'); 
    hideElement('myPostsTab'); 
    hideElement('createTab');
    
    document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
    
    if (tabName === 'discover') {
        showElement('discoverTab');
        document.getElementById('tabDiscover').classList.add('active');
    }
    if (tabName === 'myPosts') {
        showElement('myPostsTab');
        document.getElementById('tabMyPosts').classList.add('active');
        loadMyPosts();
    }
    if (tabName === 'create') {
        showElement('createTab');
        document.getElementById('tabCreate').classList.add('active');
    }
}

// ---------------- COUNTDOWN ----------------
setInterval(() => {
    document.querySelectorAll('.post-item').forEach(div=>{
        const expiresAt = new Date(div.dataset.expires);
        const now = new Date();
        if (expiresAt < now) { div.remove(); return; }
        const diff = expiresAt - now;
        const hours = Math.floor(diff/3600000);
        const minutes = Math.floor((diff%3600000)/60000);
        const seconds = Math.floor((diff%60000)/1000);
        const user = div.dataset.user || 'Unknown';
        const meta = div.querySelector('.meta');
        if (meta) meta.innerText = `Posted by ${user} • Expires in ${hours}h ${minutes}m ${seconds}s`;
    });
}, 1000);

// ---------------- REMOVE EXPIRED POSTS ----------------
async function removeExpiredPosts() {
    try {
        const nowIso = new Date().toISOString();
        await supabase.from('posts').delete().lt('expires_at', nowIso);
    } catch (err) {
        console.warn('Cleanup failed');
    }
}

setInterval(removeExpiredPosts, 3600000);
removeExpiredPosts();

// ---------------- WHATSAPP ----------------
function startContact(whatsapp) {
    if (!whatsapp) { 
        alert('WhatsApp number not available.'); 
        return; 
    }
    pendingWhatsAppUrl = `https://wa.me/${encodeURIComponent(whatsapp)}`;
    document.getElementById('contactModal').classList.add('show');
}

function closeContactModal() { 
    pendingWhatsAppUrl = null; 
    document.getElementById('contactModal').classList.remove('show'); 
}

function confirmContact() { 
    if (pendingWhatsAppUrl) window.open(pendingWhatsAppUrl, '_blank'); 
    closeContactModal(); 
}

// ---------------- LOGOUT ----------------
async function logout() { 
    await supabase.auth.signOut(); 
    location.reload(); 
}

// ---------------- EVENT LISTENERS ----------------
document.getElementById('loginBtn').addEventListener('click', handleLogin);
document.getElementById('signupBtn').addEventListener('click', handleSignup);
document.getElementById('switchToSignupBtn').addEventListener('click', switchToSignup);
document.getElementById('switchToLoginBtn').addEventListener('click', switchToLogin);
document.getElementById('logoutBtn').addEventListener('click', logout);
document.getElementById('createPostBtn').addEventListener('click', createPost);
document.getElementById('cancelContactBtn').addEventListener('click', closeContactModal);
document.getElementById('confirmWhatsAppBtn').addEventListener('click', confirmContact);

document.getElementById('tabDiscover').addEventListener('click', () => showTab('discover'));
document.getElementById('tabMyPosts').addEventListener('click', () => showTab('myPosts'));
document.getElementById('tabCreate').addEventListener('click', () => showTab('create'));

document.querySelectorAll('#filterTabs .tab').forEach(tab => {
    tab.addEventListener('click', () => filterTab(tab));
});

document.getElementById('loginEmail').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleLogin();
});
document.getElementById('loginPassword').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleLogin();
});

document.getElementById('signupWhatsapp').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleSignup();
});

// ---------------- INITIAL CHECK ----------------
(async function init() {
    try {
        const { data } = await supabase.auth.getSession();
        if (data?.session?.user) {
            currentUser = data.session.user;
            showApp();
        } else {
            hideElement('app');
            showElement('authSection');
        }
    } catch (err) {
        hideElement('app');
        showElement('authSection');
    }
})();
</script>
</body>
</html>
